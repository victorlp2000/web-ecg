<!DOCTYPE HTML>
<html>
  <head>
    <title>Mosquitto Websockets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="mqttws31.js" type="text/javascript"></script>
    <script src="jquery.min.js" type="text/javascript"></script>
    <script src="config.js" type="text/javascript"></script>
    <script src="subscriber.js" type="text/javascript"></script>
    <script src="subscriber-emulator.js" type="text/javascript"></script>
    <script src="message-queue.js" type="text/javascript"></script>
    <script src="drawing-canvas.js" type="text/javascript"></script>
    <style>
        .name {
            width:6em;
            display:inline-block;
            color: green;
        }
        .value {
            width:40em;
            display:inline-block;
            border: 0px;
            color: blue;
        }
        #canvas {
            border:3px solid #000000;
            background-color: #ffffff;
        }
    </style>
    <script type="text/javascript">
        var f_canvas;
        var f_status, f_receive, f_device, f_display, f_queue,
            f_interval, f_devicelist;
        var f_select;

        var deviceList = {};
        var activeDevice = null;
        var paint;    // canvas object

        // intervals for different speed
        var speed = 3;
        var intervals = [[1],[1],
                        [12, 11, 10, 9, 8, 7, 6, 5, 4, 3], /* speed 2 */
                        [16, 15, 14, 13, 12, 11, 10, 9], /* speed 3 */
                        ];

        var timerInterval = intervals[speed][4];
        var timer = null;
        var play = true;    // start/stop palying
        
        var messageData = null;
        var dataIndex = 0;

        var queue = new MessageQueue(20);
        var queuedMsg = 0;

        var options = {
                host: host,
                port: port,
                statusHandler: statusHandler,
                messageHandler: messageHandler,
        }

        var emulator = true;

        if (emulator == false) {
            var subscriber = new Subscriber(options);
        } else {
            var subscriber1 = new SubscriberEmulator(options);
            var subscriber2 = new SubscriberEmulator(options);
            subscriber1.setDestination('device-1');
            subscriber2.setDestination('device-2');
            subscriber1.setValueFactor(10);
            subscriber2.setValueFactor(20);
        }

        function statusHandler(text) {
            setField(f_status, text);
        }

        function setField(field, content) {
            $(field).val(content);
        }

        function changeActiveDevice(device) {
            if (activeDevice != device) {
                queue.reset();          // reset queue
                activeDevice = device;
                messageData = null;     // clear current data
                activeDevice = device;
                setField(f_device, device);
            }
        }

        function addDevice(device) {
            if (activeDevice == null) {
                changeActiveDevice(device);
            }

            // maintain device list
            var list = device;
            var changed = false;
            if (deviceList[device] == null) {
                for (dev in deviceList) {
                    list += ", " + dev;
                }
                setField(f_devicelist, list);
                changed = true;
            }
            deviceList[device] = new Date();
            if (changed) {
                resetDeviceList();
            }
        }

        function messageHandler(message) {
            var topic = message.destinationName;
            var payload = message.payloadString;
            var jsonObject = {};

            addDevice(topic);
            if (activeDevice != topic) {
                return;
            }
            jsonObject = JSON.parse(payload);
            if (jsonObject.d.packet == undefined) {
                console.log("ignore...");
                console.log(jsonObject.d);
                return;
            }
            setField(f_receive, "packet: " + jsonObject.d.packet);
            queuedMsg = queue.putMessage(jsonObject.d);
            if (queuedMsg < intervals[speed].length)
                timerInterval = intervals[speed][queuedMsg];
            else
                timerInterval = 1;
            setField(f_interval, timerInterval);
            setField(f_queue, queuedMsg);
            startPlay();
        }

        var getData = function () {
            if (messageData == null || messageData.ecg.data.length <= dataIndex) {
                messageData = queue.getMessage();
                dataIndex = 0;
                
                if (messageData != null && messageData.packet == 0) {
                    paint.clearCanvas();
                }
            }
            if (messageData == null) {
                setField(f_display, "no more data");
                timer = null;
                return;
            }
            setField(f_display, messageData.packet);
            setField(f_queue, queue.getNumberOfMessages());
            if (messageData.ecg.data.length > dataIndex) {
                var values = messageData.ecg.data.slice(dataIndex, dataIndex + speed);
                paint.drawData(values);
                dataIndex += speed;
            }
            timer = null;
            startPlay();
        }

        function startPlay() {
            if (timer == null && play == true) {
                timer = setTimeout(getData, timerInterval);
            }
        }

        function resizeCanvas() {
            var w = $(window).width();
            if (w < 200)
                w = 200;    // minimum width
            canvasWidth = w - f_canvas.offsetLeft * 2;
            f_canvas.width = canvasWidth;
            paint.clearCanvas();
        }

        // button event handler
        function onStart() {
            if (this.value == 'Stop') {
                play = false;
                this.value = 'Start';
            } else {
                play = true;
                startPlay();
                this.value = 'Stop';
            }
            console.log('play: ' + play);
        }

        // select active device
        function setActiveDevice(devie) {
            var options = f_select.options;
            for (var i = 0; i < options.length; i++) {
                if (options[i].innerHTML === device) {
                    f_select.selectedIndex = i;
                    break;
                }
            }
        }

        // change active device
        function onChangeDevice() {
            var index = f_select.selectedIndex;
            var device = f_select.options[index].innerHTML;

            changeActiveDevice(device);
            if (play == false) {
                f_start.click();
            }
        }

        // called whenever device list is changed
        function resetDeviceList() {
            var html = '';
            console.log('---' + deviceList.length);
            for (dev in deviceList) {
                html += '<option value="' + dev + '">' + dev + '</option>';
            }
            console.log(html);
            f_select.innerHTML = html;
            setActiveDevice(activeDevice);
        }

        window.onresize = function(event) {
            resizeCanvas();
        }

        $(document).ready(function() {
            f_canvas = document.getElementById('canvas');
            f_status = document.getElementById('status');
            f_receive = document.getElementById('receive');
            f_device = document.getElementById('device');
            f_display = document.getElementById('display');
            f_queue = document.getElementById('queue');
            f_interval = document.getElementById('interval');
            f_devicelist = document.getElementById('devicelist');

            f_start = document.getElementById('start');
            f_select = document.getElementById('select');

            f_start.addEventListener('click', onStart);
            f_select.addEventListener('change', onChangeDevice);
            
            paint = new DrawingCanvas(f_canvas);
            //console.log(paint);
            resizeCanvas();
            if (emulator == false) {
                subscriber.connect();
            } else {
                subscriber1.connect();
                subscriber2.connect();
            }
        });
    </script>
  </head>
  <body>
    <div>
        <div class='name'>Status:</div>
        <input type='text' class='value' id='status' readonly></input><br>
        
        <div class='name'>Receive:</div>
        <input type='text' class='value' id='receive' readonly></input><br>
        
        <div class='name'>Device:</div>
        <input type='text' class='value' id='device' readonly></input><br>
        
        <div class='name'>Display:</div>
        <input type='text' class='value' id='display' readonly></input><br>
        
        <div class='name'>Queue:</div>
        <input type='text' class='value' id='queue' readonly></input><br>
        
        <div class='name'>Interval:</div>
        <input type='text' class='value' id='interval' readonly></input><br>

        <div class='name'>Device Connected:</div>
        <input type='text' class='value' id='devicelist' readonly></input><br>
    </div>
    <canvas id="canvas" width="1" height="200"></canvas>
    <input type='button' id="start" value='Stop'></input>
    <select id='select'></select>
    <input type='button' id="move_up" value="Up"></input>
    <input type='button' id="move_down" value="Down"></input>
    <input type='button' id="narrow" value="Narrow"></input>
    <input type='button' id="wide" value="Wide"></input>
    <input type='button' id="reset" value="Reset"></input>
  </body>
</html>
