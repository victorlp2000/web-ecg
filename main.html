<!DOCTYPE HTML>
<html>
  <head>
    <title>Mosquitto Websockets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="mqttws31.js" type="text/javascript"></script>
    <script src="jquery.min.js" type="text/javascript"></script>
    <script src="config.js" type="text/javascript"></script>
    <script src="subscriber.js" type="text/javascript"></script>
    <script src="message-queue.js" type="text/javascript"></script>
    <script src="drawing-canvas.js" type="text/javascript"></script>
    <style>
        .name {
            width:6em;
            display:inline-block;
            color: green;
        }
        .value {
            width:40em;
            display:inline-block;
            border: 0px;
            color: blue;
        }
        #canvas {
            border:1px solid #000000;
        }
    </style>
    <script type="text/javascript">
        var canvasElement;
        var f_status, f_receive, f_device, f_display, f_queue, f_interval;
        var paint;    // canvas object

        var intervals = [12, 11, 10, 9, 8, 7, 6, 5, 4, 3];
        var timerInterval = intervals[4];
        var timer = null;
        
        var messageData = null;
        var dataIndex = 0;
        var speed = 2;

        var queue = new MessageQueue(20);
        var queuedMsg = 0;

        var options = {
                host: host,
                port: port,
                statusHandler: statusHandler,
                messageHandler: messageHandler,
        }

        var subscriber = new Subscriber(options);

        function statusHandler(text) {
            setValue(f_status, text);
        }

        function setValue(field, content) {
            console.log("ff:" + field);
            $(field).val(content);
        }

        function messageHandler(message) {
            var topic = message.destinationName;
            var payload = message.payloadString;
            var jsonObject = {};
            setValue(f_device, topic);
    //        try {
                jsonObject = JSON.parse(payload);
    //        } catch(err) {
    //            console.log("!!! json string error: " + payload.toString());
    //        }
            if (jsonObject.d.packet == undefined) {
                console.log("ignore...");
                console.log(jsonObject.d);
                return;
            }
            setValue(f_receive, "packet: " + jsonObject.d.packet);
            queuedMsg = queue.putMessage(jsonObject.d);
            if (queuedMsg < intervals.length)
                timerInterval = intervals[queuedMsg];
            else
                timerInterval = 1;
            setValue(f_interval, timerInterval);
            startShow();
        }

        var getData = function () {
            if (messageData == null || messageData.ecg.data.length <= dataIndex) {
                messageData = queue.getMessage();
                dataIndex = 0;
                
                if (messageData != null && messageData.packet == 0) {
                    paint.clearCanvas();
                }
            }
            if (messageData == null) {
                setValue(f_display, "no more data");
                timer = null;
                return;
            }
            setValue(f_display, messageData.packet);
            setValue(f_queue, queue.getNumberOfMessages());
            if (messageData.ecg.data.length > dataIndex) {
                var values = messageData.ecg.data.slice(dataIndex, dataIndex + speed);
                paint.drawData(values);
                dataIndex += speed;
            }
            timer = null;
            startShow();
        }

        function startShow() {
            if (timer == null) {
                timer = setTimeout(getData, timerInterval);
            }
        }

        function resizeCanvas() {
            var w = $(window).width();
            if (w < 200)
                w = 200;    // minimum width
            canvasWidth = w - canvasElement.offsetLeft * 2;
            canvasElement.width = canvasWidth;
            paint.clearCanvas();
        }

        window.onresize = function(event) {
            resizeCanvas();
        }

        $(document).ready(function() {
            canvasElement = document.getElementById('canvas');
            f_status = document.getElementById('status');
            f_receive = document.getElementById('receive');
            f_device = document.getElementById('device');
            f_display = document.getElementById('display');
            f_queue = document.getElementById('queue');
            f_interval = document.getElementById('interval');
            
            paint = new DrawingCanvas(canvasElement);
            console.log(paint);
            resizeCanvas();
            subscriber.connect();
        });
    </script>
  </head>
  <body>
    <div>
        <div class='name'>Status:</div>
        <input type='text' class='value' id='status'></input><br>
        
        <div class='name'>Receive:</div>
        <input type='text' class='value' id='receive'></input><br>
        
        <div class='name'>Device:</div>
        <input type='text' class='value' id='device'></input><br>
        
        <div class='name'>Display:</div>
        <input type='text' class='value' id='display'></input><br>
        
        <div class='name'>Queue:</div>
        <input type='text' class='value' id='queue'></input><br>
        
        <div class='name'>Interval:</div>
        <input type='text' class='value' id='interval'></input><br>
    </div>
    <canvas id="canvas" width="1" height="200"></canvas>
  </body>
</html>
