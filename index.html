<!DOCTYPE HTML>
<html>
  <head>
    <title>Mosquitto Websockets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="mqttws31.js" type="text/javascript"></script>
    <script src="jquery.min.js" type="text/javascript"></script>
    <script src="config.js" type="text/javascript"></script>
    <style>
        #status {
            border:1px solid #000000;
            width:200px;
        }
    </style>
    <script type="text/javascript">
    var mqtt;
    var reconnectTimeout = 2000;
    var topics = {};    // topic name and last receive time
    var activeTopic = null;
    var context;
    var canvasElement, statusElement;
    var canvasWidth = 1;
    var canvasHeight = 200;
    var canvasColor = "#666666";
    var strokeStyle = "#00ff00";

    function MQTTconnect() {
        mqtt = new Paho.MQTT.Client(
                        host,
                        port,
                        "web_" + parseInt(Math.random() * 100,
                        10));
        var options = {
            timeout: 3,
            useSSL: useTLS,
            cleanSession: cleansession,
            onSuccess: onConnect,
            onFailure: function (message) {
                $('#status').val("Connection failed: " + message.errorMessage + "Retrying");
                setTimeout(MQTTconnect, reconnectTimeout);
            }
        };

        mqtt.onConnectionLost = onConnectionLost;
        mqtt.onMessageArrived = onMessageArrived;

        if (username != null) {
            options.userName = username;
            options.password = password;
        }
        console.log("Host="+ host + ", port=" + port + " TLS = " + useTLS + " username=" + username + " password=" + password);
        mqtt.connect(options);
    }

    function onConnect() {
        $('#status').val('Connected to ' + host + ':' + port);
        // Connection succeeded; subscribe to our topic
        mqtt.subscribe(topic, {qos: 0});
        $('#topic').val(topic);
    }

    function onConnectionLost(response) {
        setTimeout(MQTTconnect, reconnectTimeout);
        $('#status').val("connection lost: " + response.errorMessage + ". Reconnecting");

    };

    function onMessageArrived(message) {
        var topic = message.destinationName;
        var payload = message.payloadString;
        var jsonObject = "";
        try {
            jsonObject = JSON.parse(payload);
        } catch(err) {
            console.log("!!! json string error: " + payload);
        }
        console.log(jsonObject);
        if (processData(topic, jsonObject) == false) {
            console.log(topic + ' = ' + payload);
        }
    };

    // return 'true' if the data is handled
    function processData(topic, data) {
        console.log(topic);
        topics[topic] = Date();
        if ((topic == activeTopic) || (activeTopic == null)) {
            activeTopic = topic;
            if ('d' in data) {
                if ('ecg' in data.d && 'start_ecg' in data.d) {
                    return drawEcg(data.d);
                } else {
                    console.log("no time_ecg or ecg");
                    return false;
                }
            } else {
                console.log("there is no 'd' element in the message");
                return false;
            }
        } else {
            console.log("the topic is not in active: " + topic);
            return false;
        }
    }

    function clearDrawArea(x) {
        context.fillStyle = canvasColor;
        context.fillRect(x, 0, 10, canvasHeight);
    }

    function clearCanvas() {
        context.fillStyle = canvasColor;
        context.fillRect(0, 0, canvasWidth, canvasHeight);
    }

    function drawEcg(ecgData) {
        try {
        var t = parseInt(ecgData.time_ecg) % canvasWidth;
        var d = ecgData.ecg.split(',');
        for (var i = 0; i < d.length; i ++) {
            var x = t + i;
            var y = parseInt(d[i]);
            drawDot(x, y * 3);
        }
        return true; // yes, handled
    } catch (err) {
        console.log(err);
    }
    }

    function drawDot(x, y) {
        clearDrawArea(x);
        context.fillStyle = strokeStyle;
        context.fillRect(x, canvasHeight / 2 - y, 2, 2);
        console.log('dot at: ' + x + ", " + y);
    }

    function resizeCanvas() {
        var w = $(window).width();
        if (w < 200)
            w = 200;    // minimum width
        canvasWidth = w - canvasElement.offsetLeft * 2;
        canvasElement.width = canvasWidth;
        canvasElement.height = canvasHeight;
        statusElement.style.width = (w - statusElement.offsetLeft - canvasElement.offsetLeft - 3) + 'px';
        clearCanvas();
   }

    $(document).ready(function() {
        canvasElement = document.getElementById('canvas');
        statusElement = document.getElementById('status');
        context = canvasElement.getContext('2d');
        MQTTconnect();
        resizeCanvas();
    });

    window.onresize = function(event) {
        resizeCanvas();
    }
    </script>
  </head>
  <body>
        Status: <input type='text' id='status' disabled /></div>
        <p><canvas id="canvas" width="1" height="1"></canvas></p>
    </div>
  </body>
</html>
